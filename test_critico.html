<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cr√≠tico - Escritura en Min√∫sculas</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 700px; 
            margin: 2rem auto; 
            padding: 2rem; 
            background: #f5f5f5; 
        }
        .test-container { 
            background: white; 
            padding: 2rem; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        input { 
            width: 100%; 
            padding: 1rem; 
            margin: 0.5rem 0; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 16px; 
            transition: all 0.2s ease;
        }
        .uppercase-field { 
            background: #f8f9fa; 
            text-transform: uppercase; 
        }
        .uppercase-converting { 
            background: #e3f2fd !important; 
            border-color: #2196f3 !important; 
        }
        label { 
            display: block; 
            margin: 1rem 0 0.5rem 0; 
            font-weight: bold; 
            color: #333;
        }
        .char-counter {
            position: absolute;
            right: 8px;
            bottom: 8px;
            font-size: 12px;
            color: #666;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        .result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .critical-test {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üö® Test Cr√≠tico: Escritura en Min√∫sculas</h1>
        
        <div class="critical-test">
            <h3>‚ö†Ô∏è Problema a Resolver:</h3>
            <p><strong>El usuario NO puede escribir en min√∫sculas</strong> - solo funciona con Bloq May√∫s activado.</p>
            <p><strong>DEBE FUNCIONAR:</strong> Escribir normalmente en min√∫sculas y ver conversi√≥n autom√°tica a may√∫sculas.</p>
        </div>
        
        <div id="status" class="result info">üîÑ Sistema inicializando...</div>
        
        <div style="position: relative;">
            <label for="nombreEstablecimiento">‚úÖ Nombre Establecimiento (CON conversi√≥n):</label>
            <input type="text" 
                   id="nombreEstablecimiento" 
                   class="uppercase-field"
                   placeholder="ESCRIBA AQU√ç EN MIN√öSCULAS: finca los olivos"
                   maxlength="50">
            <div class="char-counter">0/50</div>
        </div>

        <div style="position: relative;">
            <label for="calle">‚úÖ Calle (CON conversi√≥n):</label>
            <input type="text" 
                   id="calle" 
                   class="uppercase-field"
                   placeholder="ESCRIBA AQU√ç EN MIN√öSCULAS: avenida libertador"
                   maxlength="25">
            <div class="char-counter">0/25</div>
        </div>

        <div>
            <label for="normal">üîç Campo Normal (para comparar):</label>
            <input type="text" 
                   id="normal"
                   placeholder="este campo mantiene min√∫sculas">
        </div>

        <div id="testLog" class="result info" style="margin-top: 2rem;">
            <strong>Log de Pruebas:</strong><br>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let logContent = document.getElementById('logContent');
        
        function log(message, type = 'info') {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div style="margin: 2px 0; color: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'}">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // Funci√≥n para contador de caracteres simplificada
        function addCharacterCounter(inputId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = input.parentNode.querySelector('.char-counter');
            
            function updateCounter() {
                const currentLength = input.value.length;
                counter.textContent = `${currentLength}/${maxLength}`;
                counter.style.color = currentLength >= maxLength * 0.9 ? '#dc3545' : 
                                     currentLength >= maxLength * 0.8 ? '#ffc107' : '#666';
            }
            
            input.addEventListener('input', updateCounter);
            log(`üìä Contador configurado para ${inputId}`, 'info');
        }

        // Funci√≥n para conversi√≥n a may√∫sculas MEJORADA
        function addUppercaseConverter(inputId) {
            const input = document.getElementById(inputId);
            if (!input) {
                log(`‚ùå Campo ${inputId} no encontrado`, 'error');
                return false;
            }
            
            log(`üîß Configurando conversi√≥n para ${inputId}`, 'info');
            
            function convertToUppercase() {
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const value = input.value;
                const upperValue = value.toUpperCase();
                
                if (value !== upperValue) {
                    input.value = upperValue;
                    input.setSelectionRange(start, end);
                    
                    input.classList.add('uppercase-converting');
                    setTimeout(() => input.classList.remove('uppercase-converting'), 120);
                    
                    log(`‚úÖ Convertido en ${inputId}: "${value}" ‚Üí "${upperValue}"`, 'success');
                    updateStatus(`‚úÖ ¬°FUNCIONA! Convertido: "${value}" ‚Üí "${upperValue}"`);
                }
            }
            
            // Event listeners cr√≠ticos
            input.addEventListener('input', () => {
                log(`üìù Input detectado en ${inputId}: "${input.value}"`, 'info');
                setTimeout(convertToUppercase, 0);
            });
            
            input.addEventListener('keydown', (e) => {
                log(`‚å®Ô∏è Tecla presionada en ${inputId}: ${e.key} (code: ${e.code})`, 'info');
                setTimeout(convertToUppercase, 0);
            });
            
            input.addEventListener('paste', () => {
                log(`üìã Pegado detectado en ${inputId}`, 'info');
                setTimeout(convertToUppercase, 10);
            });
            
            // Configuraci√≥n
            input.style.textTransform = 'uppercase';
            input.setAttribute('data-uppercase', 'true');
            input.setAttribute('autocapitalize', 'characters');
            
            log(`‚úÖ Campo ${inputId} configurado correctamente`, 'success');
            return true;
        }
        
        function updateStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = message.includes('‚úÖ') ? 'result success' : 
                              message.includes('‚ùå') ? 'result error' : 'result info';
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Iniciando test cr√≠tico...', 'info');
            updateStatus('üîÑ Configurando sistema...');
            
            // Configurar contadores
            addCharacterCounter('nombreEstablecimiento', 50);
            addCharacterCounter('calle', 25);
            
            // Configurar conversi√≥n (CR√çTICO)
            const result1 = addUppercaseConverter('nombreEstablecimiento');
            const result2 = addUppercaseConverter('calle');
            
            if (result1 && result2) {
                log('‚úÖ SISTEMA CONFIGURADO CORRECTAMENTE', 'success');
                updateStatus('‚úÖ Sistema listo - PRUEBE escribir en min√∫sculas');
            } else {
                log('‚ùå ERROR EN LA CONFIGURACI√ìN', 'error');
                updateStatus('‚ùå Error en la configuraci√≥n del sistema');
            }
            
            // Test autom√°tico despu√©s de 2 segundos
            setTimeout(() => {
                log('ü§ñ Ejecutando test autom√°tico...', 'info');
                const testField = document.getElementById('nombreEstablecimiento');
                testField.value = 'test autom√°tico';
                testField.dispatchEvent(new Event('input', { bubbles: true }));
            }, 2000);
        });
        
        // Monitor global cr√≠tico
        document.addEventListener('keydown', function(e) {
            if (e.target.getAttribute('data-uppercase') === 'true') {
                log(`üéØ Tecla global: ${e.key} en campo ${e.target.id}`, 'info');
            }
        });
    </script>
</body>
</html>