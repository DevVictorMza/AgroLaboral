<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ofertas P√∫blicas - Agro Laboral</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">üß™ Test Sistema de Ofertas P√∫blicas</h1>
        
        <!-- Estado del Sistema -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üîß Estado del Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-status">
                            <p>üîÑ Iniciando tests...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Resultados</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <p>‚è≥ Esperando resultados...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Test -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üéÆ Controles de Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-primary" onclick="testCargarTodasLasOfertas()">
                                üìã Cargar Todas las Ofertas
                            </button>
                            <button type="button" class="btn btn-success" onclick="testFiltrarPorPuesto()">
                                üîç Filtrar PODADOR/ATADOR
                            </button>
                            <button type="button" class="btn btn-warning" onclick="testGeolocalizacion()">
                                üìç Test Geolocalizaci√≥n
                            </button>
                            <button type="button" class="btn btn-info" onclick="testOrdenDistancia()">
                                üìè Orden por Distancia
                            </button>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-secondary" onclick="limpiarResultados()">
                                üßπ Limpiar
                            </button>
                            <button type="button" class="btn btn-danger" onclick="testErrores()">
                                ‚ö†Ô∏è Test Errores
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Ofertas (igual que en index.html) -->
        <section id="ofertas-disponibles" class="container py-5">
            <div class="row justify-content-center mb-4">
                <div class="col-lg-10">
                    <div class="card h-100 shadow-sm border-0 servicio-card servicio-card-ofertas">
                        <div class="card-body text-center">
                            <div class="mb-3 servicio-icon servicio-icon-ofertas"><i class="fas fa-briefcase"></i></div>
                            <h2 class="fw-bold">Ofertas Disponibles - Test</h2>
                            <p class="mb-0">Pruebas del sistema de ofertas p√∫blicas</p>
                            <div class="mt-3">
                                <span id="contador-ofertas-publicas" class="badge bg-success fs-6">Iniciando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filtros de Ofertas P√∫blicas -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-10">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <div class="row g-3 align-items-center">
                                <!-- Filtro por Puesto -->
                                <div class="col-md-4">
                                    <label for="filtro-puesto-publico" class="form-label">
                                        <i class="fas fa-briefcase me-1"></i>
                                        Filtrar por puesto
                                    </label>
                                    <select class="form-select" id="filtro-puesto-publico">
                                        <option value="">Todos los puestos</option>
                                        <option value="PODADOR/ATADOR">Podador/Atador</option>
                                        <option value="COSECHADOR">Cosechador</option>
                                        <option value="TRACTORISTA">Tractorista</option>
                                        <option value="CAPATAZ">Capataz</option>
                                        <option value="VI√ëATERO">Vi√±atero</option>
                                        <option value="JORNALERO">Jornalero</option>
                                        <option value="SUPERVISOR">Supervisor</option>
                                    </select>
                                </div>
                                
                                <!-- Ordenamiento -->
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-sort me-1"></i>
                                        Ordenar por
                                    </label>
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-orden-publico active" data-orden="fecha">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            Fecha
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-orden-publico" data-orden="distancia">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            Distancia
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Geolocalizaci√≥n -->
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fas fa-location-arrow me-1"></i>
                                        Ubicaci√≥n
                                    </label>
                                    <button type="button" class="btn btn-outline-secondary w-100" id="btn-geolocalizacion">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Activar ubicaci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Container de Ofertas -->
            <div class="row g-4 justify-content-center" id="ofertas-publicas-container">
                <!-- Las ofertas se cargar√°n aqu√≠ din√°micamente -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando ofertas...</span>
                    </div>
                    <p class="mt-3 text-muted">Preparando sistema de ofertas...</p>
                </div>
            </div>
            
            <!-- Spinner de carga -->
            <div id="ofertas-publicas-spinner" class="text-center py-3 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Actualizando ofertas...</span>
                </div>
            </div>
        </section>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- App JS -->
    <script src="js/app.js"></script>

    <script>
        // Funciones de test espec√≠ficas
        async function testCargarTodasLasOfertas() {
            actualizarEstadoTest('Probando carga de todas las ofertas...');
            try {
                const ofertas = await cargarOfertasPublicas({ orden: 'fecha' });
                actualizarResultadoTest(`‚úÖ Cargadas ${ofertas.length} ofertas ordenadas por fecha`);
            } catch (error) {
                actualizarResultadoTest(`‚ùå Error cargando ofertas: ${error.message}`);
            }
        }

        async function testFiltrarPorPuesto() {
            actualizarEstadoTest('Probando filtro por puesto PODADOR/ATADOR...');
            try {
                const ofertas = await cargarOfertasPublicas({ 
                    puesto: 'PODADOR/ATADOR',
                    orden: 'fecha' 
                });
                actualizarResultadoTest(`‚úÖ Filtro por puesto: ${ofertas.length} ofertas de PODADOR/ATADOR`);
            } catch (error) {
                actualizarResultadoTest(`‚ùå Error filtrando por puesto: ${error.message}`);
            }
        }

        async function testGeolocalizacion() {
            actualizarEstadoTest('Probando geolocalizaci√≥n...');
            try {
                const ubicacion = await getUbicacionUsuario();
                actualizarResultadoTest(`‚úÖ Ubicaci√≥n obtenida: lat=${ubicacion.lat.toFixed(4)}, lon=${ubicacion.lon.toFixed(4)}`);
            } catch (error) {
                actualizarResultadoTest(`‚ö†Ô∏è Error de geolocalizaci√≥n: ${error.message}`);
            }
        }

        async function testOrdenDistancia() {
            actualizarEstadoTest('Probando orden por distancia...');
            try {
                // Usar coordenadas de ejemplo si no hay geolocalizaci√≥n
                if (!estadoOfertasPublicas.ubicacion.disponible) {
                    estadoOfertasPublicas.ubicacion = {
                        lat: -33.06,
                        lon: -68.47,
                        disponible: true
                    };
                }
                
                const ofertas = await cargarOfertasPublicas({ 
                    orden: 'distancia'
                });
                actualizarResultadoTest(`‚úÖ Orden por distancia: ${ofertas.length} ofertas ordenadas por cercan√≠a`);
            } catch (error) {
                actualizarResultadoTest(`‚ùå Error ordenando por distancia: ${error.message}`);
            }
        }

        function testErrores() {
            actualizarEstadoTest('Simulando errores...');
            mostrarErrorOfertasPublicas(new Error('HTTP 500 - Error simulado para testing'));
            actualizarResultadoTest('‚ö†Ô∏è Error simulado mostrado correctamente');
        }

        function limpiarResultados() {
            document.getElementById('test-status').innerHTML = '<p>üîÑ Sistema listo para tests...</p>';
            document.getElementById('test-results').innerHTML = '<p>‚è≥ Sin resultados...</p>';
            
            // Cargar ofertas por defecto
            cargarOfertasPublicas({ orden: 'fecha' });
        }

        function actualizarEstadoTest(mensaje) {
            document.getElementById('test-status').innerHTML = `<p>üîÑ ${mensaje}</p>`;
        }

        function actualizarResultadoTest(resultado) {
            const resultados = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            resultados.innerHTML += `<p><small class="text-muted">${timestamp}</small><br>${resultado}</p>`;
        }

        // Auto-inicializar al cargar
        document.addEventListener('DOMContentLoaded', function() {
            actualizarEstadoTest('Inicializando sistema de ofertas p√∫blicas...');
            
            setTimeout(async () => {
                try {
                    await inicializarOfertasPublicas();
                    actualizarEstadoTest('‚úÖ Sistema inicializado correctamente');
                    actualizarResultadoTest('üöÄ Sistema de ofertas p√∫blicas funcionando');
                } catch (error) {
                    actualizarEstadoTest('‚ùå Error en inicializaci√≥n');
                    actualizarResultadoTest(`‚ùå Error: ${error.message}`);
                }
            }, 1000);
        });
    </script>
</body>
</html>