<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Geolocalizaci√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/map-markers.css">
</head>
<body>
    <div class="container-fluid">
        <h1>üîç Debug Geolocalizaci√≥n</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Estado del Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div id="status-info">
                            <p><strong>Navegador:</strong> <span id="browser-info"></span></p>
                            <p><strong>Geolocation API:</strong> <span id="geo-support"></span></p>
                            <p><strong>HTTPS:</strong> <span id="https-status"></span></p>
                            <p><strong>Permisos:</strong> <span id="permissions-status"></span></p>
                        </div>
                        
                        <button id="test-geo" class="btn btn-primary">
                            <i class="fas fa-location-arrow"></i> Probar Geolocalizaci√≥n
                        </button>
                        
                        <div id="test-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Mapa de Prueba</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-map" style="height: 400px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Log de Eventos</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-log" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funci√≥n para agregar logs
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Verificar estado del sistema
        document.addEventListener('DOMContentLoaded', function() {
            // Info del navegador
            document.getElementById('browser-info').textContent = navigator.userAgent.split(' ').pop();
            
            // Soporte de geolocalizaci√≥n
            const geoSupport = 'geolocation' in navigator;
            document.getElementById('geo-support').innerHTML = geoSupport 
                ? '<span class="text-success">‚úÖ Soportado</span>' 
                : '<span class="text-danger">‚ùå No soportado</span>';
            
            // HTTPS
            const isHttps = location.protocol === 'https:';
            document.getElementById('https-status').innerHTML = isHttps 
                ? '<span class="text-success">‚úÖ Conexi√≥n segura</span>' 
                : '<span class="text-warning">‚ö†Ô∏è HTTP (algunos navegadores requieren HTTPS)</span>';
            
            addLog('Sistema iniciado', 'info');
            
            // Verificar permisos
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    document.getElementById('permissions-status').innerHTML = 
                        `<span class="text-${result.state === 'granted' ? 'success' : result.state === 'denied' ? 'danger' : 'warning'}">
                            ${result.state.toUpperCase()}
                        </span>`;
                    addLog(`Permisos de geolocalizaci√≥n: ${result.state}`, result.state === 'granted' ? 'success' : 'info');
                });
            } else {
                document.getElementById('permissions-status').textContent = 'No disponible';
            }
            
            // Inicializar mapa de prueba
            initTestMap();
        });

        // Mapa de prueba
        let testMap;
        let userMarker;

        function initTestMap() {
            addLog('Inicializando mapa de prueba...', 'info');
            
            testMap = L.map('test-map').setView([-32.89, -68.83], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(testMap);
            
            addLog('Mapa inicializado correctamente', 'success');
        }

        // Prueba de geolocalizaci√≥n
        document.getElementById('test-geo').addEventListener('click', function() {
            const button = this;
            const resultsDiv = document.getElementById('test-results');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo ubicaci√≥n...';
            
            addLog('Iniciando prueba de geolocalizaci√≥n...', 'info');
            
            if (!navigator.geolocation) {
                addLog('ERROR: Geolocalizaci√≥n no soportada', 'error');
                resultsDiv.innerHTML = '<div class="alert alert-danger">Geolocalizaci√≥n no soportada</div>';
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-location-arrow"></i> Probar Geolocalizaci√≥n';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    addLog(`Ubicaci√≥n obtenida: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
                    addLog(`Precisi√≥n: ¬±${Math.round(accuracy)}m`, 'info');
                    
                    // Mostrar en el mapa
                    if (userMarker) {
                        testMap.removeLayer(userMarker);
                    }
                    
                    // Crear icono rojo personalizado
                    const redIcon = L.divIcon({
                        className: 'user-location-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    userMarker = L.marker([lat, lng], {
                        icon: redIcon
                    }).addTo(testMap);
                    
                    userMarker.bindPopup(`
                        <strong>Tu ubicaci√≥n</strong><br>
                        Lat: ${lat.toFixed(6)}<br>
                        Lng: ${lng.toFixed(6)}<br>
                        Precisi√≥n: ¬±${Math.round(accuracy)}m
                    `).openPopup();
                    
                    // Centrar mapa
                    testMap.flyTo([lat, lng], 15);
                    
                    // C√≠rculo de precisi√≥n
                    if (accuracy < 1000) {
                        L.circle([lat, lng], {
                            radius: accuracy,
                            color: '#dc3545',
                            fillColor: '#dc3545',
                            fillOpacity: 0.1
                        }).addTo(testMap);
                    }
                    
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>‚úÖ Ubicaci√≥n obtenida exitosamente</h6>
                            <p><strong>Latitud:</strong> ${lat.toFixed(6)}</p>
                            <p><strong>Longitud:</strong> ${lng.toFixed(6)}</p>
                            <p><strong>Precisi√≥n:</strong> ¬±${Math.round(accuracy)} metros</p>
                        </div>
                    `;
                    
                    addLog('Marcador rojo creado y mostrado en el mapa', 'success');
                },
                function(error) {
                    let message = 'Error desconocido';
                    let details = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Permisos denegados';
                            details = 'El usuario deneg√≥ el acceso a la ubicaci√≥n. Verifica la configuraci√≥n del navegador.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Ubicaci√≥n no disponible';
                            details = 'La informaci√≥n de ubicaci√≥n no est√° disponible. Verifica tu conexi√≥n GPS/WiFi.';
                            break;
                        case error.TIMEOUT:
                            message = 'Tiempo agotado';
                            details = 'La solicitud de ubicaci√≥n ha excedido el tiempo l√≠mite.';
                            break;
                    }
                    
                    addLog(`ERROR: ${message} - ${details}`, 'error');
                    
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>‚ùå ${message}</h6>
                            <p>${details}</p>
                        </div>
                    `;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
            
            // Restaurar bot√≥n despu√©s de un tiempo
            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-location-arrow"></i> Probar Geolocalizaci√≥n';
            }, 15000);
        });
    </script>
</body>
</html>