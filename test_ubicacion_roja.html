<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Geolocalizaci√≥n - AgroLaboral</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #test-map {
            height: 500px;
            width: 100%;
            border: 3px solid #dc3545;
            border-radius: 10px;
        }
        .big-button {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="text-center mb-4">
            <h1 class="text-danger">üéØ Test de Geolocalizaci√≥n</h1>
            <p class="lead">Prueba directa para verificar que el marcador rojo aparezca</p>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div id="test-map"></div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-cog"></i> Controles de Prueba</h5>
                    </div>
                    <div class="card-body">
                        <button id="btn-test-geo" class="btn btn-danger big-button w-100">
                            <i class="fas fa-location-arrow"></i> Obtener Mi Ubicaci√≥n
                        </button>
                        
                        <button id="btn-clear-map" class="btn btn-secondary w-100">
                            <i class="fas fa-eraser"></i> Limpiar Mapa
                        </button>
                        
                        <div id="status-display" class="mt-3">
                            <div class="status-box status-info">
                                <i class="fas fa-info-circle"></i> Listo para probar
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Informaci√≥n del Sistema:</h6>
                            <small>
                                <div><strong>Navegador:</strong> <span id="browser-info"></span></div>
                                <div><strong>Geolocalizaci√≥n:</strong> <span id="geo-support"></span></div>
                                <div><strong>Protocolo:</strong> <span id="protocol-info"></span></div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-terminal"></i> Log de Eventos</h5>
                    </div>
                    <div class="card-body">
                        <div id="log-container" style="height: 200px; overflow-y: auto; background: #000; color: #00ff00; padding: 10px; font-family: monospace; border-radius: 5px;">
                            <div>üöÄ Sistema iniciado - Esperando comando...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let testMap;
        let userMarker;
        let precisionCircle;
        
        // Funci√≥n para agregar logs
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ff00',
                'error': '#ff0000',
                'success': '#00ffff',
                'warning': '#ffff00'
            };
            
            logContainer.innerHTML += `<div style="color: ${colors[type] || '#00ff00'}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Funci√≥n para mostrar estado
        function showStatus(message, type = 'info') {
            const statusDisplay = document.getElementById('status-display');
            const icons = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle',
                'loading': 'fas fa-spinner fa-spin'
            };
            
            statusDisplay.innerHTML = `
                <div class="status-box status-${type}">
                    <i class="${icons[type] || 'fas fa-info-circle'}"></i> ${message}
                </div>
            `;
        }
        
        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üì± Inicializando sistema de prueba...');
            
            // Informaci√≥n del sistema
            document.getElementById('browser-info').textContent = navigator.userAgent.split(' ').pop();
            document.getElementById('geo-support').innerHTML = 'geolocation' in navigator 
                ? '<span class="text-success">‚úÖ Soportado</span>' 
                : '<span class="text-danger">‚ùå No soportado</span>';
            document.getElementById('protocol-info').textContent = location.protocol;
            
            // Inicializar mapa
            initTestMap();
            
            // Event listeners
            document.getElementById('btn-test-geo').addEventListener('click', testGeolocation);
            document.getElementById('btn-clear-map').addEventListener('click', clearMap);
            
            addLog('‚úÖ Sistema listo para pruebas');
        });
        
        function initTestMap() {
            addLog('üó∫Ô∏è Inicializando mapa de prueba...');
            
            testMap = L.map('test-map').setView([-32.89, -68.83], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(testMap);
            
            addLog('‚úÖ Mapa inicializado correctamente');
        }
        
        function clearMap() {
            addLog('üßπ Limpiando mapa...');
            
            if (userMarker) {
                testMap.removeLayer(userMarker);
                userMarker = null;
            }
            if (precisionCircle) {
                testMap.removeLayer(precisionCircle);
                precisionCircle = null;
            }
            
            testMap.setView([-32.89, -68.83], 10);
            showStatus('Mapa limpiado', 'info');
            addLog('‚úÖ Mapa limpiado');
        }
        
        function testGeolocation() {
            addLog('üåç === INICIANDO TEST DE GEOLOCALIZACI√ìN ===');
            showStatus('Obteniendo tu ubicaci√≥n...', 'loading');
            
            const button = document.getElementById('btn-test-geo');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo...';
            
            if (!navigator.geolocation) {
                addLog('‚ùå ERROR: Geolocalizaci√≥n no soportada', 'error');
                showStatus('Tu navegador no soporta geolocalizaci√≥n', 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-location-arrow"></i> Obtener Mi Ubicaci√≥n';
                return;
            }
            
            addLog('üì° Solicitando ubicaci√≥n al GPS/WiFi...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    addLog(`‚úÖ UBICACI√ìN OBTENIDA:`, 'success');
                    addLog(`   üìç Latitud: ${lat.toFixed(6)}`, 'success');
                    addLog(`   üìç Longitud: ${lng.toFixed(6)}`, 'success');
                    addLog(`   üéØ Precisi√≥n: ¬±${Math.round(accuracy)} metros`, 'success');
                    
                    // Limpiar marcadores anteriores
                    clearMap();
                    
                    // Crear marcador rojo SUPER visible
                    const redIcon = L.divIcon({
                        html: `
                            <div style="
                                background: #ff0000;
                                width: 30px;
                                height: 30px;
                                border-radius: 50%;
                                border: 5px solid white;
                                box-shadow: 0 0 0 3px #ff0000, 0 0 20px rgba(255,0,0,0.8);
                                position: relative;
                                animation: pulse 2s infinite;
                            "></div>
                            <style>
                                @keyframes pulse {
                                    0% { transform: scale(1); opacity: 1; }
                                    50% { transform: scale(1.2); opacity: 0.7; }
                                    100% { transform: scale(1); opacity: 1; }
                                }
                            </style>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    
                    userMarker = L.marker([lat, lng], {
                        icon: redIcon,
                        zIndexOffset: 10000
                    }).addTo(testMap);
                    
                    // Popup con informaci√≥n
                    userMarker.bindPopup(`
                        <div style="text-align: center; min-width: 200px;">
                            <h4 style="color: red; margin: 0;">üéØ TU UBICACI√ìN</h4>
                            <hr>
                            <p><strong>Latitud:</strong> ${lat.toFixed(6)}</p>
                            <p><strong>Longitud:</strong> ${lng.toFixed(6)}</p>
                            <p><strong>Precisi√≥n:</strong> ¬±${Math.round(accuracy)}m</p>
                            <p style="color: green;"><strong>‚úÖ MARCADOR ROJO VISIBLE</strong></p>
                        </div>
                    `).openPopup();
                    
                    // C√≠rculo de precisi√≥n
                    if (accuracy < 5000) {
                        precisionCircle = L.circle([lat, lng], {
                            radius: accuracy,
                            color: '#ff0000',
                            fillColor: '#ff0000',
                            fillOpacity: 0.2,
                            weight: 3
                        }).addTo(testMap);
                        
                        addLog(`üéØ C√≠rculo de precisi√≥n agregado (${Math.round(accuracy)}m)`, 'success');
                    }
                    
                    // Centrar mapa
                    testMap.flyTo([lat, lng], 16);
                    
                    showStatus('‚úÖ ¬°MARCADOR ROJO VISIBLE! Ubicaci√≥n encontrada exitosamente', 'success');
                    addLog('‚úÖ === GEOLOCALIZACI√ìN COMPLETADA EXITOSAMENTE ===', 'success');
                    
                    // Restaurar bot√≥n
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-location-arrow"></i> Obtener Mi Ubicaci√≥n';
                },
                function(error) {
                    let message = 'Error desconocido';
                    let details = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Permisos denegados';
                            details = 'Ve a configuraci√≥n del navegador ‚Üí Privacidad ‚Üí Ubicaci√≥n ‚Üí Permitir para este sitio';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Ubicaci√≥n no disponible';
                            details = 'Verifica que el GPS est√© activado o que tengas conexi√≥n WiFi';
                            break;
                        case error.TIMEOUT:
                            message = 'Tiempo agotado';
                            details = 'La solicitud de ubicaci√≥n tard√≥ demasiado. Intenta nuevamente.';
                            break;
                    }
                    
                    addLog(`‚ùå ERROR: ${message}`, 'error');
                    addLog(`üí° Soluci√≥n: ${details}`, 'warning');
                    
                    showStatus(`‚ùå ${message}: ${details}`, 'error');
                    
                    // Restaurar bot√≥n
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-location-arrow"></i> Obtener Mi Ubicaci√≥n';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000
                }
            );
        }
    </script>
</body>
</html>